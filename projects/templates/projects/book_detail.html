{% extends 'main.html' %}
{% load static %}

{% block content %}
<div class="page">
<head>
    <link rel="stylesheet" type="text/css" href="{% static 'book-detail.css' %}">
</head>
<div class="page">
    <div class="header">
        <h2>{{ book.name }} By {{book.author}}</h2>
    </div>
    <div class="book-detail">
        <div class="book-title">
            <h1>Title: {{ book.name }}</h1>
        </div>
        <p class="book-author">Author: {{ book.author }}</p>
        {% if book.cover_image_url %}
                <img src="{{ book.cover_image_url }}" alt="Cover image for {{ book.name }}">
        {% else %}
                <p>No cover image available.</p>
         {% endif %}
        <p class="book-description">Description: {{ book.description }}</p>
        <!-- Voting form -->
        <div class="voting-section">
            <form id="vote-form" method="post" action="{% url 'vote' book.id  %}">
                {% csrf_token %}
                <button type="submit" name="vote" value="up" class="vote-button vote-up">Vote Up</button>
                <button type="submit" name="vote" value="down" class="vote-button vote-down">Vote Down</button>
            </form>
            <p id="vote-total">Votes: {{ book.vote_total }}</p>
            <p id="vote-ratio">Rating: {{ book.vote_ratio }}%</p>
        </div>
        
        <!-- Read button -->
        <form method="POST" id="toggle_read_status-form">
            {% csrf_token %}
            <button type="submit" class="read-button">
                {% if is_read %}
                    Remove from Read List
                {% else %}
                    Mark as Read
                {% endif %}
            </button>
        </form>


        <!-- Comment form -->
        <div class="comment-section">
            <h3>Add a Comment</h3>
            <form method="POST" action="{% url 'post_comment' book.id %}" class="comment-form">
                {% csrf_token %}
                <textarea name="comment" class="comment-textarea" placeholder="Write your comment here..."></textarea>
                <button type="submit" class="comment-submit">Add comment</button> 
            </form>

            <div class="comments-list">
                {% for comment in book.comment_set.all %}
                    <div class="comment">
                        <p class="comment-user">{{ comment.user.username|default:"Anonymous" }} says:</p>
                        <p class="comment-body">{{ comment.body }}</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function(){
        var form = document.getElementById('vote-form');
        form.addEventListener('submit', function(e){
            e.preventDefault(); // Prevent the form from submitting the traditional way
            
            // Check if user is authenticated
            if (!{{ user.is_authenticated|yesno:"true,false" }}) {
                alert('You must be logged in to vote. Please login or register.');
                window.location.href = '{% url 'login' %}';
                return; // Stop further execution if not authenticated
            }
    
            var actionUrl = form.getAttribute('action');
            var xhr = new XMLHttpRequest();
            xhr.open('POST', actionUrl, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
    
            xhr.onload = function () {
                if (xhr.status >= 200 && xhr.status < 400) {
                    var data = JSON.parse(xhr.responseText);
                    document.getElementById('vote-total').textContent = 'Votes: ' + data.vote_total;
                    document.getElementById('vote-ratio').textContent = 'Rating: ' + data.vote_ratio + '%';
                } else {
                    console.error('Server returned an error on the vote submission.');
                }
            };
    
            xhr.onerror = function () {
                console.error('An error occurred during the vote submission.');
            };
    
            var requestData = 'vote=' + form.querySelector('button[name="vote"]:focus').value;
            xhr.send(requestData);
        });
    
        function getCookie(name) {
            var cookieValue = null;
            var cookies = document.cookie.split(';');
            for(var i=0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
            return cookieValue;
        }
    });
    </script>
    

<!-- AJAX script for toggling the read status -->
<script>
    // Determine if the user is authenticated using Django template tags
    var isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }}; 
    document.addEventListener("DOMContentLoaded", function() {
        var form = document.getElementById('toggle_read_status-form');
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent the default form submission
    
            // Check if the user is authenticated
            if (!isAuthenticated) {
                alert('You must be logged in to mark books as read. Please login or register.');
                window.location.href = '{% url 'login' %}'; // Redirect them to the login page
                return; // Stop further execution of this script
            }
    
            var formData = new FormData(this);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
            fetch("{% url 'toggle_read_status' book.id %}", {
                method: 'POST',
                body: formData,
                credentials: 'same-origin' // Include cookies in the request
            })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON only if response is valid
                }
                throw new Error('Network response was not ok.');
            })
            .then(data => {
                console.log(data); // Log the JSON data
                const readButton = document.querySelector('.read-button');
                if (data.read) {
                    readButton.textContent = 'Remove from Read List'; // Update button text to remove
                } else {
                    readButton.textContent = 'Mark as Read'; // Update button text to mark as read
                }
                alert(data.message); // Notify the user of the action taken
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred, please try again.');
            });
        });
    });
    </script>
    <!-- AJAX script for posting comments -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var commentForm = document.getElementById('commentForm');
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent the default form submission
        
                // Check if user is authenticated
                if (!{{ user.is_authenticated|yesno:"true,false" }}) {
                    alert('You must be logged in to add comments. Please login or register.');
                    window.location.href = '{% url 'login' %}';
                    return; // Stop further execution if not authenticated
                }
        
                var formData = new FormData(this);
        
                fetch('{% url 'post_comment' book.id %}', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin' // Include cookies in the request
                })
                .then(response => {
                    if (response.ok) {
                        return response.json(); // Parse JSON only if response is valid
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    // Assuming the server returns the created comment data
                    console.log(data);
                    // Append the new comment to the comment list
                    var commentsList = document.getElementById('commentsList');
                    var newComment = `<div class="comment">
                        <p class="comment-user">${data.username} says:</p>
                        <p class="comment-body">${data.comment}</p>
                    </div>`;
                    commentsList.insertAdjacentHTML('beforeend', newComment);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred, please try again.');
                });
            });
        });
        </script>
        

{% endblock %}