{% extends 'main.html' %}
{% load static %}

{% block content %}
<div class="page">
    <head>
      <link rel="stylesheet" type="text/css" href="{% static 'book-detail.css' %}">
    </head>
    
    <div class="bookpage_gridcontainer">
      <div class="bookpage_leftcolumn">
          <img src="{{ book.cover_image_url }}" alt="Cover image for {{ book.name }}">
          {% if book.googlebooks_link != "No buy link." %}
          <p class="book-buy-link"><a href="{{ book.googlebooks_link }}" class="buy-button">Want to read</a></p>
        {% else %}
          <p class="book-buy-link">Buy: Not available</p>
        {% endif %}
        <div class="voting-section">
          <form id="vote-form" method="post" action="{% url 'vote' book.id %}">
            {% csrf_token %}
            <button type="submit" name="vote" value="up" class="vote-button vote-up"><i class="fa-solid fa-thumbs-up"></i></button>
            <button type="submit" name="vote" value="down" class="vote-button vote-down"><i class="fa-solid fa-thumbs-down"></i></button>
          </form>
        </div>
        
        
      </div>
      <div class="bookpage_rightcolumn">
        <div class="book-info">
          <div class="book-title">
            <h1>{{ book.name }}</h1>
          </div>
          <p class="book-author">{{ book.author }}</p>
          <div class="star-rating">
            <span>★ ★ ★ ★ ☆</span>
            <span class="rating-value">{{ book.rating }}</span>
          </div>
          <div class="voteinfo">
            <p id="vote-total">Votes: {{ book.vote_total }}</p>
            <p id="vote-ratio">Rating: {{ book.vote_ratio }}%</p>
          </div>
          <div class="book-description">
            <div class="short-description">
              {{ book.description|linebreaks }}
            </div>
            <div class="full-description" style="display: none;">
              {{ book.description|linebreaks }}
            </div>
            <button class="read-more-button">Show more <span class="arrow">&#x25BC;</span></button>
          </div>
          <p class="book-published">Published: {{ book.published_year }}</p>
          <div class="genres">
            <p>Genres:</p>
            <ul>
              {% for genre in book.genres.all %}
                <li>{{ genre.categories }}</li>
              {% endfor %}
            </ul>
          </div>
          
          <!-- Read button -->
          <form method="POST" id="toggle_read_status-form">
            {% csrf_token %}
            <button type="submit" class="read-button">
              {% if is_read %}
                Remove from Read List
              {% else %}
                Mark as Read
              {% endif %}
            </button>
          </form>

        </div>

        <div class="comment-section">
          <h3>Add a Comment</h3>
          <form method="POST" action="{% url 'post_comment' book.id %}" class="comment-form">
            {% csrf_token %}
            <textarea name="comment" class="comments-textarea" placeholder="Write your comment here..."></textarea>
            <button type="submit" class="comments-submit">Add comment</button>
          </form>
          <div class="comments-list">
            {% for comment in book.comment_set.all %}
              <div class="comment">
                <p class="comment-user">{{ comment.user.username|default:"Anonymous" }} says:</p>
                <p class="comment-body">{{ comment.body }}</p>
              </div>
            {% endfor %}
          </div>
        </div>
        </div>
    </div>
   
  
</div>
<script>
    document.addEventListener("DOMContentLoaded", function(){
        var form = document.getElementById('vote-form');
        form.addEventListener('submit', function(e){
            e.preventDefault(); // Prevent the form from submitting the traditional way
            
            // Check if user is authenticated
            if (!{{ user.is_authenticated|yesno:"true,false" }}) {
                alert('You must be logged in to vote. Please login or register.');
                window.location.href = '{% url 'login' %}';
                return; // Stop further execution if not authenticated
            }
    
            var actionUrl = form.getAttribute('action');
            var xhr = new XMLHttpRequest();
            xhr.open('POST', actionUrl, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
    
            xhr.onload = function () {
                if (xhr.status >= 200 && xhr.status < 400) {
                    var data = JSON.parse(xhr.responseText);
                    document.getElementById('vote-total').textContent = 'Votes: ' + data.vote_total;
                    document.getElementById('vote-ratio').textContent = 'Rating: ' + data.vote_ratio + '%';
                } else {
                    console.error('Server returned an error on the vote submission.');
                }
            };
    
            xhr.onerror = function () {
                console.error('An error occurred during the vote submission.');
            };
    
            var requestData = 'vote=' + form.querySelector('button[name="vote"]:focus').value;
            xhr.send(requestData);
        });
    
        function getCookie(name) {
            var cookieValue = null;
            var cookies = document.cookie.split(';');
            for(var i=0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
            return cookieValue;
        }
    });
    </script>
    

<!-- AJAX script for toggling the read status -->
<script>
    // Determine if the user is authenticated using Django template tags
    var isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }}; 
    document.addEventListener("DOMContentLoaded", function() {
        var form = document.getElementById('toggle_read_status-form');
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent the default form submission
    
            // Check if the user is authenticated
            if (!isAuthenticated) {
                alert('You must be logged in to mark books as read. Please login or register.');
                window.location.href = '{% url 'login' %}'; // Redirect them to the login page
                return; // Stop further execution of this script
            }
    
            var formData = new FormData(this);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
            fetch("{% url 'toggle_read_status' book.id %}", {
                method: 'POST',
                body: formData,
                credentials: 'same-origin' // Include cookies in the request
            })
            .then(response => {
                if (response.ok) {
                    return response.json(); // Parse JSON only if response is valid
                }
                throw new Error('Network response was not ok.');
            })
            .then(data => {
                console.log(data); // Log the JSON data
                const readButton = document.querySelector('.read-button');
                if (data.read) {
                    readButton.textContent = 'Remove from Read List'; // Update button text to remove
                } else {
                    readButton.textContent = 'Mark as Read'; // Update button text to mark as read
                }
                alert(data.message); // Notify the user of the action taken
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred, please try again.');
            });
        });
    });
    </script>
    <!-- AJAX script for posting comments -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var commentForm = document.getElementById('commentForm');
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent the default form submission
        
                // Check if user is authenticated
                if (!{{ user.is_authenticated|yesno:"true,false" }}) {
                    alert('You must be logged in to add comments. Please login or register.');
                    window.location.href = '{% url 'login' %}';
                    return; // Stop further execution if not authenticated
                }
        
                var formData = new FormData(this);
        
                fetch('{% url 'post_comment' book.id %}', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin' // Include cookies in the request
                })
                .then(response => {
                    if (response.ok) {
                        return response.json(); // Parse JSON only if response is valid
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    // Assuming the server returns the created comment data
                    console.log(data);
                    // Append the new comment to the comment list
                    var commentsList = document.getElementById('commentsList');
                    var newComment = `<div class="comment">
                        <p class="comment-user">${data.username} says:</p>
                        <p class="comment-body">${data.comment}</p>
                    </div>`;
                    commentsList.insertAdjacentHTML('beforeend', newComment);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred, please try again.');
                });
            });
        });
        </script>
        <!-- JavaScript for toggling the read more/less button -->
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const readMoreButton = document.querySelector('.read-more-button');
            const shortDescription = document.querySelector('.short-description');
            const fullDescription = document.querySelector('.full-description');
            const fullText = fullDescription.textContent.trim();
            const maxLength = 600; // Maximum number of characters for the short description
        
            if (fullText.length > maxLength) {
              const truncatedText = fullText.substring(0, maxLength) + '...';
              shortDescription.textContent = truncatedText;
              shortDescription.style.display = 'block';
            } else {
              shortDescription.textContent = fullText;
              readMoreButton.style.display = 'none'; // Hide the button if the text isn't too long
            }
        
            readMoreButton.addEventListener('click', function() {
              if (fullDescription.style.display === 'none') {
                fullDescription.style.display = 'block';
                shortDescription.style.display = 'none';
                readMoreButton.textContent = 'Show less ';
                readMoreButton.classList.add('active');
                readMoreButton.insertAdjacentHTML('beforeend', '<span class="arrow">&#x25B2;</span>');
              } else {
                fullDescription.style.display = 'none';
                shortDescription.style.display = 'block';
                readMoreButton.textContent = 'Show more ';
                readMoreButton.classList.remove('active');
                readMoreButton.insertAdjacentHTML('beforeend', '<span class="arrow">&#x25BC;</span>');
              }
            });
          });
        </script>

{% endblock %}